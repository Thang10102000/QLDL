<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	lang="vi">
<head th:replace="fragments/html-head">
<meta charset="utf-8">
<title>Thêm mới yêu cầu dịch vụ</title>
</head>
<body>
	<form th:action="@{/service-request/create}" method='POST' enctype="multipart/form-data">
		<table class="table table-condensed col">
			<tr>
				<td style="width: 50%">
					<label for="areaId">Công ty khu vực</label>
					<select name="areaId" id="areaId" class="form-control">
						<option value="all" th:if="${#lists.size(agencyArea) >= 2}">-- Chọn công ty khu vực --</option>
						<option th:each="area : ${agencyArea}"
								th:value="${area.areaId}"
								th:text="${area.areaName}">
						</option>
					</select>
				</td>
				<td><label for="customer_info">Khách hàng<b class="required">(*)</b></label>
					<select name="customer_info" id="customer_info" class="form-control selectNew">
						<option value="">-- Chọn khách hàng --</option>
					</select></td>
			</tr>
			<tr>
				<td>
					<label for="service">Dịch vụ</label>
					<select name="service" id="service" class="form-control">
						<option value="">-- Chọn dịch vụ --</option>
						<option th:each="s : ${services}" 
								th:value="${s.id}" 
								th:text="${s.serviceName}">
						</option>
					</select>
				</td>
				<td>
					<label for="package_gr">Nhóm gói cước</label>
					<select name="package_gr" id="package_gr" class="form-control selectNew">
						<option value="">-- Chọn nhóm gói cước --</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>
					<label for="policy_c">Chính sách<b class="required">(*)</b></label>
					<select name="policy_c" id="policy_c" class="form-control">
						<option value="MP">Miễn phí</option>
						<option value="CK">Chiết khấu</option>
						<option value="HH">Hoa Hồng</option>
					</select>
				</td>
				<td>
					<label for="pkg">Gói cước<b class="required">(*)</b></label>
					<select name="pkg" id="pkg" class="form-control selectNew">
						<option value="">-- Chọn gói cước --</option>
					</select>
				</td>
			</tr>
			<tr>
				<td><label for="price">Giá bán<b class="required">(*)</b></label>
					<input type="text" class="form-control"
					name="price" id="price"></td>
				<td><label for="discount">Chiết khấu</label>
					<input type="text" class="form-control"
					name="discount" id="discount"></td>
			</tr>
			<tr>
				<td><label for="quantity">Số lượng<b class="required">(*)</b></label>
					<input type="text" class="form-control"
					name="quantity" id="quantity"></td>
				<td><label for="amount">Thành tiền<b class="required">(*)</b></label>
					<input type="text" class="form-control"
					name="amount" id="amount" readonly></td>
			</tr>
			<tr>
				<td>
					<label for="contractFile">Hợp đồng</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<input id="contractFile" type="file" name="contract_files[]" multiple onchange="updateList()">
				</td>
				<td>
					<label for="payFile">Hồ sơ thanh toán</label>
					<input id="payFile" type="file" name="pay_files[]" multiple onchange="updateList()">
				</td>
			</tr>
			<tr>
				<td>
					<label for="scanFile">Scan văn bản</label>
					<input id="scanFile" type="file" name="scan_files[]" multiple onchange="updateList()">
				</td>
			</tr>
			<tr class='control'>
				<td colspan='4' align='center'>
					<button class="btn btn-primary button-control" id="doAdd"
						type="submit">
						<i class="fa fa-plus-square"></i> THÊM MỚI
					</button>&nbsp;
					<a type="button" id="doBack"
						class="btn btn-primary button-control"  data-dismiss="modal"><i
						class="fa fa-undo" aria-hidden="true"></i> Quay lại</a>&nbsp;
				</td>
			</tr>
		</table>
	</form>
	<link rel="stylesheet" href="/vasonline/style/upload-file.css">
	<script src="/vasonline/js/upload_multi-file.js"></script>
	<script src="/vasonline/js/custom_service.js"></script>
	<script src="/vasonline/js/select2.min.js"></script>
	<script type="text/javascript">
		$(".selectNew").select2();
		$(document).ready(function() {
			$('#sidebarCollapse').on('click', function() {
				$('#sidebar').toggleClass('active');
			});
		});
		$("#doAdd").on('click', function (e) {
			if ($("#customer_info").val() == null) {
				toastr.error('Bạn chưa chọn khách hàng');
				return false;
			}
			if ($("#pkg").val() == null) {
				toastr.error('Bạn chưa chọn gói cước');
				return false;
			}
			if ($("#price").val() == '') {
				toastr.error('Bạn chưa điền giá bán');
				return false;
			}
			if ($("#quantity").val() == '') {
				toastr.error('Bạn chưa điền số lượng');
				return false;
			}
		});

		$("#service").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			var linkPost = "/vasonline/brand-group-list?idService="+ value.toString();

			$.ajax({
				url: linkPost,
				method: 'GET',
				success: function(data) {

					var str ='';
					str +=' <option>-- Chọn nhóm gói cước --</option>'
					for (let i = 0; i < data.length ; i++) {
						str +=' <option value= "'+data[i].id+'" >'+data[i].groupName+'</option>'
					}
					$('#package_gr').html(str);

				},
				error: function(request) {
					alert("The request failed: " + request.responseText);
				}
			});
		});
		var lstBrand=[];
		$("#package_gr").on("change", function (e) {
			lstBrand=[]
			let value = Array.from(e.target.selectedOptions, option => option.value);
			var linkPost = "/vasonline/brand-list?idBrand="+ value.toString();

			$.ajax({
				url: linkPost,
				method: 'GET',
				success: function(data) {
					lstBrand=data;
					var str ='';
					str +=' <option value="">-- Chọn gói cước --</option>'
					for (let i = 0; i < data.length ; i++) {
						if ($("#policy_c").val() == 'CK' && data[i].priceDiscount > 0){
							str +=' <option value= "'+data[i].id+'" >'+ data[i].brandId +'-'+data[i].brandName+'</option>'
						}
						if ($("#policy_c").val() == 'HH' && data[i].price > 0 && data[i].priceDiscount == 0){
							str +=' <option value= "'+data[i].id+'" >'+ data[i].brandId +'-'+data[i].brandName+'</option>'
						}
						if ($("#policy_c").val() == 'MP' && data[i].price == 0 && data[i].priceDiscount == 0) {
							str +=' <option value= "'+data[i].id+'" >'+ data[i].brandId +'-'+data[i].brandName+'</option>'
						}

					}
					$('#pkg').html(str);

				},
				error: function(request) {
					alert("The request failed: " + request.responseText);
				}
			});
		});

		$("#pkg").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			var policy = $('#policy_c').find(":selected").val();
			var linkPost = "/vasonline/service-request/get-price-discount?policyCode="+policy.toString()+"&brandId="+ value.toString();

			$.ajax({
				url: linkPost,
				method: 'GET',
				success: function(data) {
					let item = JSON.parse(data);
					$('#price').val(item.price);
					$('#discount').val(item.discount);
					var quan = $('#quantity').val();
					var pri = $('#price').val();
					var amount = quan * pri;
					$('#amount').val(amount);
				},
				error: function(request) {
					alert("The request failed: " + request.responseText);
				}
			});
		});

		$("#policy_c").on("change", function (e) {
			var str ='';
			str +=' <option value="">-- Chọn gói cước --</option>'
			//show brand theo policy
			if (lstBrand.length > 0){
				for (let i = 0; i < lstBrand.length ; i++) {
					if ($("#policy_c").val() == 'CK' && lstBrand[i].priceDiscount > 0){
						str +=' <option value= "'+lstBrand[i].id+'" >'+ lstBrand[i].brandId +'-'+lstBrand[i].brandName+'</option>'
					}
					if ($("#policy_c").val() == 'HH' && lstBrand[i].price > 0 && lstBrand[i].priceDiscount == 0){
						str +=' <option value= "'+lstBrand[i].id+'" >'+ lstBrand[i].brandId +'-'+lstBrand[i].brandName+'</option>'
					}
					if ($("#policy_c").val() == 'MP' && lstBrand[i].price == 0 && lstBrand[i].priceDiscount == 0) {
						str +=' <option value= "'+lstBrand[i].id+'" >'+ lstBrand[i].brandId +'-'+lstBrand[i].brandName+'</option>'
					}
				}
				$('#pkg').html(str);
			}
			if ($("#pkg").val() != null && $("#pkg").val() != ''){
				let value = Array.from(e.target.selectedOptions, option => option.value);
				var pkg = $('#pkg').find(":selected").val();
				var linkPost = "/vasonline/service-request/get-price-discount?policyCode="+value.toString()+"&brandId="+ pkg.toString();

				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function(data) {
						let item = JSON.parse(data);
						$('#price').val(item.price);
						$('#discount').val(item.discount);
						var quan = $('#quantity').val();
						var pri = $('#price').val();
						var amount = quan * pri;
						$('#amount').val(amount);
					},
					error: function(request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
		});

		$("#quantity").on("keyup", function (e) {
			var quan = $('#quantity').val();
			var pri = $('#price').val();
			var amount = quan * pri;
			$('#amount').val(amount);
		});

		if($("#areaId").val() != ''){
			if($("#areaId").val() == 'all'){
				console.log($("#areaId").val());
				var linkCustomer = "/vasonline/get-allcustomer";
				$.ajax({
					url: linkCustomer,
					method: 'GET',
					success: function(data) {
						var str ='';
						str +=' <option>-- Chọn khách hàng --</option>';
						for (let i = 0; i < data.length ; i++) {
							str +=' <option value= "'+data[i].id+'" >'+data[i].name+'</option>'
						}
						$('#customer_info').html(str);
					},
					error: function(request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
			else {
				var linkCustomer = "/vasonline/get-customer-area?areaId=" + $("#areaId").val();
				$.ajax({
					url: linkCustomer,
					method: 'GET',
					success: function (data) {
						var str = '';
						str += ' <option>-- Chọn khách hàng --</option>';
						for (let i = 0; i < data.length; i++) {
							str += ' <option value= "' + data[i].id + '" >' + data[i].name + '</option>'
						}
						$('#customer_info').html(str);
					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
		}

		$("#areaId").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			if(value != '') {
				if(value == 'all'){
					var linkCustomer = "/vasonline/get-allcustomer";
					$.ajax({
						url: linkCustomer,
						method: 'GET',
						success: function(data) {
							var str ='';
							str +=' <option>-- Chọn khách hàng --</option>';
							for (let i = 0; i < data.length ; i++) {
								str +=' <option value= "'+data[i].id+'" >'+data[i].name+'</option>'
							}
							$('#customer_info').html(str);
						},
						error: function(request) {
							alert("The request failed: " + request.responseText);
						}
					});
				}
				else {
					var linkCustomer = "/vasonline/get-customer-area?areaId=" + value.toString();
					$.ajax({
						url: linkCustomer,
						method: 'GET',
						success: function (data) {
							var str = '';
							str += ' <option>-- Chọn khách hàng --</option>';
							for (let i = 0; i < data.length; i++) {
								str += ' <option value= "' + data[i].id + '" >' + data[i].name + '</option>'
							}
							$('#customer_info').html(str);
						},
						error: function (request) {
							alert("The request failed: " + request.responseText);
						}
					});
				}
			}
			else {
				$('#customer_info').html('');
			}
		});

	</script>
</body>

</html>