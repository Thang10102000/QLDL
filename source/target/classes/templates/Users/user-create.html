<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	lang="vi">
<head th:replace="fragments/html-head">
<meta charset="utf-8">
<title>Thêm tài khoản</title>
</head>
<body>
	<div class="wrapper" sec:authorize="isAuthenticated()">
		<div class="box box-primary table-responsive">
			<!-- sec:authorize="hasAuthority('Quản lý tài khoản:Thêm')"> -->
			<form th:action="@{/admin/user-management/create}" method='POST' id ="Add_Form">
				<table class="table table-sm">
					<tr>
						<td><label for="username">Tên đăng nhập <strong class="required">(*)</strong></label>
							<input type="text" class="form-control" placeholder="Username" name="username"
							id="username" autocomplete="off">
							<span class="required" id="messageUsername"></span>
						</td>
						<td><label for="email">Email <strong
								class="required">(*)</strong></label>
							<input type="text" class="form-control" placeholder="Email"
							name="email" id="email"><span class="required" id="messageEmail"></span>
						</td>
					</tr>
					<tr>
						<td><label for="password">Mật khẩu <strong
								class="required">(*)</strong></label> <input type="password"
							class="form-control" placeholder="Password" name="password"
							id="password"><span class="required" id="messagePassword"></span>
						</td>
						<td><label for="re-password">Nhập lại mật khẩu <strong
								class="required">(*)</strong></label> <input
								type="password" class="form-control" placeholder="Password"
								name="re-password" id="re-password">
							<span class="required" id="messageRePassword"></span>
						</td>
					</tr>
					<tr>
						<td><label for="phone">Số điện thoại <strong
								class="required">(*)</strong></label>
							<input type="text" class="form-control" placeholder="Phone"
								   name="phone" id="phone"><span class="required" id="messagePhone"></span>
						</td>
						<td><label for="fax">Số Fax</label>
							<input type="text" class="form-control" placeholder="Fax" name="fax"
							id="fax"><span class="required" id="messageFax"></span>
						</td>
					</tr>
					<tr>
						<td><label for="fullname">Tên đầy đủ <strong
								class="required">(*)</strong></label> <input type="text"
							class="form-control" placeholder="Fullname" name="fullname"
							id="fullname"><span class="required" id="messageFullname"></span>
						</td>
						<td><label for="address">Địa chỉ <strong
								class="required">(*)</strong></label> <textarea
								class="form-control" placeholder="Address" name="address"
								id="address" rows="1"></textarea>
								<span class="required" id="messageAddress"></span>
						</td>
					</tr>
					<tr>
						<td><label for="levels">Cấp tài khoản <strong
								class="required">(*)</strong></label> <select name="levels"
							id="levels" class="form-control">
								<option value="">--Chọn cấp tài khoản--</option>
								<option th:each="l : ${levelsNotInAmkam}" th:value="${l.levelId}"
									th:text="${l.levelName}"></option>
						</select><span class="required" id="messageLevels"></span>
						</td>
						<td><label for="groups">Nhóm tài khoản</label>
							<select name="groups"
							id="groups" class="form-control">
								<option value="">--Chọn nhóm--</option>
						</select></td>
					</tr>
					<tr>
						<td class="selectArea" hidden><label for="areaId">Công ty khu vực <strong class="required">(*)</strong></label> <select
							name="areaId" id="areaId" class="form-control">
								<option value="">-- Chọn công ty khu vực --</option>
								<option th:each="area : ${myArea}"
									th:value="${area.areaId}" th:text="${area.areaName}"></option>
						</select>
							<span class="required" id="messageArea"></span>
						</td>
						<td class="selectAgency" hidden><label for="agencyId">Đại lý <strong class="required">(*)</strong>
						</label> <select name="agencyId" id="agencyId"
							class="form-control">
								<option value="">--Chọn đại lý--</option>
						</select>
							<span class="required" id="messageAgency"></span>
						</td>
					</tr>
					<tr>
						<td><input type="checkbox" name="never-expired" class="form-check-input"
							id="never-expired" style="margin-top: 5px;"> <label class="form-check-label"
							for="never-expired">Mật khẩu không thời hạn</label></td>
						<td></td>
					</tr>
					<tr class='control'>
						<td colspan='4' align='center'>
							<button class="btn btn-primary button-control" id="doAdd"
								type="submit">
								<i class="fa fa-plus-square"></i> THÊM MỚI
							</button>&nbsp;
							<a type="button" id="doBack"
								class="btn btn-primary button-control"  data-dismiss="modal"><i
								class="fa fa-undo" aria-hidden="true"></i> Quay lại</a>&nbsp;
						</td>
					</tr>
				</table>
			</form>
		</div>
	</div>
	<script src="/vasonline/js/custom_service.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			$('#sidebarCollapse').on('click', function() {
				$('#sidebar').toggleClass('active');
			});
			$('#Add_Form').submit(function(){
				$("#doAdd", this)
						.html("Đang xử lý...")
						.attr('disabled', 'disabled');
				return true;
			});
			$("#Add_Form input[name=\"username\"], #Add_Form input[name=\"email\"], #Add_Form input[name=\"password\"], #Add_Form input[name=\"re-password\"], #Add_Form input[name=\"phone\"], #Add_Form input[name=\"fax\"], #Add_Form input[name=\"fullname\"], #levels, #address").keydown(function () {
				$("#messageUsername").text("");
				$("#messageEmail").text("");
				$("#messagePassword").text("");
				$("#messagePhone").text("");
				$("#messageRePassword").text("");
				$("#messageFax").text("");
				$("#messageFullname").text("");
				$("#messageLevels").text("");
				$("#messageAddress").text("");
			});
		});
		$("#areaId, #agencyId").on('change', function () {
			$("#messageArea").text("");
			$("#messageAgency").text("");
		});

		$("#levels").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			var levelId = value.toString();
			if(levelId === '2'){
				$(".selectArea").removeAttr('hidden');
				$(".selectAgency").attr("hidden", true);
				$(".selectAgency #agencyId").val("");
				$(".selectAgency #agencyId").trigger("change");
			}
			else if(levelId === '4'){
				$(".selectAgency").removeAttr('hidden');
				$(".selectArea").removeAttr('hidden');
			}
			else{
				$(".selectArea").attr("hidden", true);
				$(".selectArea #areaId").val("");
				$(".selectArea #areaId").trigger("change");
				$(".selectAgency").attr("hidden", true);
				$(".selectAgency #agencyId").val("");
				$(".selectAgency #agencyId").trigger("change");
			}
		});
		$("#levels").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			let url = "/vasonline/admin/group/select?groupLevel="+ value.toString();
			if(!isNaN(value) && value!=""){
				$.ajax({
					url: url,
					method: 'GET',
					success: function(data) {
						let str = '<option value="">--Chọn nhóm--</option>';
						let requestGroupData = Object.keys(data);
						requestGroupData.sort();
						requestGroupData.forEach((item) => {
							let jsonItem = JSON.parse(item);
							str += ' <option value= "' + jsonItem.groupId + '" >' + jsonItem.groupName + '</option>';
						})
						$('#groups').html(str);
					},
					error: function(request) {
						alert("Chọn cấp tài khoản");
						let errStr = '<option value= "" >--Chọn nhóm--</option>';
						$('#groups').html(errStr);
					}
				});
			}else{
				let errStr = '<option value= "" >--Chọn nhóm--</option>';
				$('#groups').html(errStr);
			}
		});
		$(".selectArea #areaId").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			let url = "/vasonline/agency-list?idAgencyArea="+ value.toString();
			if(!isNaN(value) && value!=""){
				$.ajax({
					url: url,
					method: 'GET',
					success: function(data) {
						let str = '<option value="">--Chọn đại lý--</option>';
						for (let i = 0; i < data.length ; i++) {
							str +=' <option value= "'+data[i].id+'" >'+data[i].agencyName+'</option>'
						}
						$('.selectAgency #agencyId').html(str);
					},
					error: function(request) {
						alert("Chọn đại lý");
						let errStr = '<option value= "" >--Chọn đại lý--</option>';
						$('.selectAgency #agencyId').html(errStr);
					}
				});
			}else{
				let errStr = '<option value= "" >--Chọn đại lý--</option>';
				$('.selectAgency #agencyId').html(errStr);
			}
		});
		$("#doAdd").on('click', function () {
			$("span.required").html("");
			var format = /[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
			var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
			if ($('#Add_Form input[name="username"]').val() === ''){
				$("#messageUsername").text("Tên đăng nhập bắt buộc nhập");
				$("#messageUsername").focus();
				return false;
			}
			if ($('#Add_Form input[name="email"]').val() === ''){
				$("#messageEmail").text("Email bắt buộc nhập");
				$("#messageEmail").focus();
				return false;
			}
			if (!re.test($('#Add_Form input[name="email"]').val())) {
				$("#messageEmail").text("Email sai định dạng");
				$("#messageEmail").focus();
				return false;
			}
			if($('#Add_Form input[name="password"]').val() === ''){
				$("#messagePassword").text("Mật khẩu bắt buộc nhập");
				$("#messagePassword").focus();
				return false;
			}
			if($('#Add_Form input[name="password"]').val() != $('#Add_Form input[name="re-password"]').val()){
				$("#messageRePassword").text("Mật khẩu không trùng khớp");
				$("#messageRePassword").focus();
				return false;
			}
			if($('#Add_Form input[name="phone"]').val() === ''){
				$("#messagePhone").text("SĐT bắt buộc nhập");
				$("#messagePhone").focus();
				return false;
			}
			if($('#Add_Form input[name="phone"]').val()*1 != $('#Add_Form input[name="phone"]').val()){
				$("#messagePhone").text("SĐT chỉ chứa kí tự số");
				$("#messagePhone").focus();
				return false;
			}
			if ($('#Add_Form input[name="phone"]').val().length > 13 || $('#Add_Form input[name="phone"]').val().length < 9){
				$("#messagePhone").text("SĐT sai định dạng");
				$("#messagePhone").focus();
				return false;
			}
			if($('#Add_Form input[name="fax"]').val()*1 != $('#Add_Form input[name="fax"]').val()){
				$("#messageFax").text("Số Fax sai định dạng");
				$("#messageFax").focus();
				return false;
			}
			if($('#Add_Form input[name="fullname"]').val() === ''){
				$("#messageFullname").text("Họ tên bắt buộc nhập");
				$("#messageFullname").focus();
				return false;
			}
			if(format.test($('#Add_Form input[name="fullname"]').val())){
				$("#messageFullname").text("Họ tên chứa kí tự đặc biệt");
				$("#messageFullname").focus();
				return false;
			}
			if($("#levels").val() === ''){
				$("#messageLevels").text("Chọn cấp tài khoản");
				$("#messageLevels").focus();
				return false;
			}
			if($("#address").val() === ''){
				$("#messageAddress").text("Địa chỉ bắt buộc nhập");
				$("#messageAddress").focus();
				return false;
			}
			if($("#levels").val() == '2' && $("#areaId").val() === ''){
				$("#messageArea").text("Chọn công ty khu vực - trung tâm");
				$("#areaId").focus();
				return false;
			}
			if(($("#levels").val() == '3'|| $("#levels").val() == '4' ) && $("#agencyId").val() === ''){
				$("#messageAgency").text("Chọn đại lý , AM/KAM");
				$("#agencyId").focus();
				return false;
			}
		})
		var invalidChars = [ "-", "e", ",", "." ];
		$("#phone , #fax ").on("keydown", function(e) {
			if (invalidChars.includes(e.key)) {
				e.preventDefault();
			}
		});
	</script>
</body>

</html>