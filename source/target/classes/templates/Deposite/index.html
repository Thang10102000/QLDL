<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-head">
<meta charset="UTF-8">
<title>Quản lý bảo lãnh thanh toán đặt cọc</title>
</head>
<body>
	<div class="wrapper">
		<!-- Sidebar  -->
		<nav id="sidebar" th:replace="fragments/sidebar"></nav>

		<!-- Page Content  -->
		<div id="content">
			<div class="div-navbar" th:replace="fragments/div-navbar"></div>
				<div class="container-fluid ">
					<div class="heading">
						<h3>QUẢN LÝ BẢO LÃNH THANH TOÁN ĐẶT CỌC</h3>
					</div>
				
				<div class="box box-primary">
					<form>
						<table class="table table-condensed col">
							<tr>
								<td style="width: 50%">
								<label for="areaIdSearch">Công ty khu vực</label>
									<select name="areaIdSearch" id="areaIdSearch" class="form-control" th:if="${#lists.size(agencyArea) >= 2}">
										<option value="">--Chọn công ty khu vực--</option>
										<option th:each="j : ${agencyArea}"
												th:value="${j.areaId}" th:text="${j.areaName}" ></option>
									</select>
									<select name="areaIdSearch" id="areaIdSearch" class="form-control" th:if="${#lists.size(agencyArea) < 2}">
										<option th:each="j : ${agencyArea}"
												th:value="${j.areaId}" th:text="${j.areaName}" ></option>
									</select>
										<span id="areaId_msg"></span>
								</td>
								<td style="width: 50%"><label for="agencyNameSearch">Đại lý</label>
									<select name="agencyNameSearch" id="agencyNameSearch" class="form-control" th:if="${agency != null}">
										<option th:each="ag : ${agency}" th:value="${ag.id}" th:text="${ag.agencyName}" ></option>
									</select>
									<select name="agencyNameSearch" id="agencyNameSearch" class="form-control" th:if="${agency == null}">
										<option value="">--Chọn đại lý--</option>
									</select>
								</td>
							</tr>
							<tr>
								<td><label for="startDateSearch">Ngày bắt đầu</label> <input
									type="text" name="startDateSearch" class="form-control" id="startDateSearch" autocomplete="off" /></td>
								<td><label for="endDateSearch">Ngày kết thúc</label> <input
									type="text" name="endDateSearch" class="form-control" id="endDateSearch" autocomplete="off" /></td>
							</tr>
							<tr>
								<td><label for="depositeAmountSearch">Số tiền bảo lãnh</label> <input
									type="number" name="depositeAmountSearch" class="form-control"
									id="depositeAmountSearch" autocomplete="off"></td>
								<td><label for="statusSearch">Trạng thái</label> <select
									name="statusSearch" id="statusSearch" class="form-control">
										<option value="">--Chọn trạng thái--</option>
										<option value="1">Hiệu lực</option>
										<option value="0">Không hiệu lực</option>
								</select></td>
							</tr>
							<tr class='control'>
								<td colspan='4' align='center'>
									<button type="button" class="btn btn-primary button-control"
										name="doSearch" id="doSearch">
										<i class="fa fa-search"></i> Tìm kiếm
									</button>&nbsp;
									<button type="button" id="doNew" class="btn btn-primary button-control" data-target="#modal-command-type-create">
										<i class="fa fa-plus-square"></i>
										Thêm mới
								</button>&nbsp;
								</td>
							</tr>
						</table>
				</form>
				</div>
				<div class="list-service box box-primary">
					<table class="table table-bordered" id="listData">
						<thead>
						<tr align="center">
							<th>Tên đại lý</th>
							<th>Số tiền bảo lãnh (VNĐ)</th>
							<th>Ngày bắt đầu</th>
							<th>Ngày kết thúc</th>
							<th>Trạng thái</th>
							<th>Hành động</th>
						</tr>
						</thead>
						<tbody id="tableBody"></tbody>
					</table>
					<nav aria-label="Page navigation">
						<ul class="pagination">
							<li class="page-item"><span id="totalPage"></span></li>
							<li class="page-item"><span id="pageSize"></span></li>
							<li class="page-item">
								<div class="form-group">
									<select class="form-control" name="selector"
											onChange="resetPage()">
										<option>10</option>
										<option>20</option>
										<option>50</option>
										<option>100</option>
										<option>200</option>
									</select>
								</div>
							</li>
							<li class="page-item"><span>&nbsp;</span></li>
							<li class="page-item"><a class="page-link"
													 onClick="firstPage()"><i class="fa fa-angle-double-left"></i></a></li>
							<li class="page-item"><a class="page-link"
													 onClick="prevPage()"><i class="fa fa-angle-left"></i></a></li>
							<li class="page-item"><a id="prePage"></a></li>
							<li class="page-item"><a class="page-link" id="currentPage">1</a></li>
							<li class="page-item"><a id="nexPage"></a></li>
							<li class="page-item"><a class="page-link"
													 onClick="nextPage()"><i class="fa fa-angle-right"></i></a></li>
							<li class="page-item"><a class="page-link"
													 onClick="lastPage()"><i class="fa fa-angle-double-right"></i></a></li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</div>

	<!--modal form create-->
	<div class="modal fade in" id="modal-command-type-create" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title">
						<h4 class="modal-title">THÊM MỚI BẢO LÃNH THANH TOÁN, ĐẶT CỌC</h4>
					</div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="create_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>

		</div>
	</div>

	<!--modal form edit-->
	<div class="modal fade in" id="modal-command-type-edit" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">CHỈNH SỬA BẢO LÃNH ĐẶT CỌC <strong id="modal-title-edit" style="color: #ff0000;"> </strong></h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="edit_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>
	<script src="/vasonline/js/custom_service.js"></script>
	<script src="/vasonline/js/deposite-search.js"></script>
	<script type="text/javascript">

		function messageSuccess(){
			toastr.success('Thành công');
		}
		function messageFailed(){
			toastr.error('Thất bại');
		}
		$(document).on("click", ".delete", function(e) {
			e.preventDefault();
			var r = confirm("Bạn muốn xóa quản lý bảo lãnh đặt cọc?");
			if (r){
				window.location = $(this).attr('href');
			}
		})
	$(function() {
		let agencyId = localStorage.getItem("agencyIdForDeposite");
		let areaId = localStorage.getItem("areaIdForDeposite");
		$(document).ready(function() {
			if(areaId != null){
				$("#areaIdSearch").val(areaId);
			}
			let messageResponse = '[[${message}]]';
			let error = '[[${error}]]';
			let erD = '[[${errDelete}]]'
			if(messageResponse == 'success'){
				messageSuccess();
			}
			if (messageResponse == 'failed'){
				messageFailed();
			}
			if (error != ''){
				toastr.error(error);
			}
			if(erD != ''){
				toastr.error(erD);
			}
			if ($("#areaIdSearch").val() != '' && $("#agencyNameSearch").val() == ""){
				var linkPost = "/vasonline/agency-list?idAgencyArea="+ $("#areaIdSearch").val();
				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function(data) {
						var str ='<option value="">--Chọn đại lý--</option>';
						for (let i = 0; i < data.length ; i++) {
							str +='<option value= "'+data[i].id+'" >'+data[i].agencyName+'</option>'
						}
						$('#agencyNameSearch').html(str);
					},
					error: function(request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
			if(areaId != null && $("#agencyNameSearch").val() == ""){
				var linkPost = "/vasonline/agency-list?idAgencyArea=" + areaId;
				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function (data) {
						var str = '<option value="">--Chọn đại lý--</option>';

						for (let i = 0; i < data.length; i++) {
							if(data[i].id == agencyId){
								str += ' <option value= "' + data[i].id + '" selected >' + data[i].agencyName + '</option>'
							}else {
								str += ' <option value= "' + data[i].id + '" >' + data[i].agencyName + '</option>'
							}
						}
						$('#agencyNameSearch').html(str);
					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
		});
		$("#areaIdSearch").on("change", function (e) {
            let value = Array.from(e.target.selectedOptions, option => option.value);
            // $('input:hidden[name=brand]').val(value);
            var linkPost = "/vasonline/agency-list?idAgencyArea="+ value;

            $.ajax({
                url: linkPost,
                method: 'GET',
                success: function(data) {

                    var str ='<option value="">--Chọn đại lý--</option>';

                    for (let i = 0; i < data.length ; i++) {
                        str +='<option value= "'+data[i].id+'" >'+data[i].agencyName+'</option>'
                    }
                    $('#agencyNameSearch').html(str);

                },
                error: function(request) {
                    alert("The request failed: " + request.responseText);
                }
            });
        })
	});
	$(function() {
		$("#doSearch").click();
		localStorage.removeItem("agencyIdForDeposite");
		localStorage.removeItem("areaIdForDeposite");
	});
	
	$("#startDateSearch").datepicker({ format: "dd/mm/yyyy",todayHighlight: true})
	$("#endDateSearch").datepicker({ format: "dd/mm/yyyy",todayHighlight: true})
	</script>
</body>
</html>
