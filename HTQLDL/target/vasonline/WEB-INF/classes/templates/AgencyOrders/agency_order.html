<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	lang="vi">
<head th:replace="fragments/html-head">
<meta charset="utf-8">
<title>Quản lý đơn hàng</title>
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar  -->
		<nav id="sidebar" th:replace="fragments/sidebar"></nav>

		<!-- Page Content  -->
		<div id="content">
			<div class="div-navbar" th:replace="fragments/div-navbar"></div>
			<div class="container-fluid ">
				<div class="heading">
					<h3>QUẢN LÝ ĐƠN HÀNG</h3>
				</div>
				<div class="box box-primary">
					<form>
						<table class="table table-condensed col">
							<tr>
								<td>
									<label for="selectCTKVSearch">Công ty khu vực<b class="required">(*)</b></label>
									<select name="selectCTKV" id="selectCTKVSearch"
											class="selectService  form-control ">
										<option value="all" th:if="${#lists.size(agencyArea) >= 2}">--Chọn CTKV--</option>
										<option
												th:each="aga : ${agencyArea}"
												th:value="${aga.areaId}"
												th:text="${aga.areaName}"></option>
									</select>
								</td>
								<td style="width: 50%;"><label for="agencyNameSearch">Đại lý - AM/KAM </label>
									<select name="agencyName" id="agencyNameSearch" class="form-control select">
										<option value="">-- Chọn đại lý - AM/KAM --</option>
										<option
												th:each="ag : ${agency}"
												th:value="${ag.id}"
												th:text="${ag.agencyName}"></option>
									</select>
								</td>
							</tr>
							<tr>
								<td><label for="startDateSearch">Ngày bắt đầu</label> <input
									type="text" name="startDate" id="startDateSearch"
									class="form-control" placeholder="Ngày bắt đầu"
									autocomplete="off"></td>
								<td><label for="endDateSearch">Ngày kết thúc</label> <input
									type="text" name="endDate" id="endDateSearch" class="form-control"
									placeholder="Ngày kết thúc" autocomplete="off"></td>
							</tr>
							<tr>
								<td><label for="orderIdSearch">Mã đơn hàng</label> <input
										type="text" name="orderId" id="orderIdSearch" class="form-control"
										placeholder="Mã đại lý" autocomplete="off"></td>
								<td><label for="statusSearch">Trạng thái đơn hàng</label> <select
									name="status" id="statusSearch" class="form-control" >
										<option value="">--Chọn trạng thái--</option>
										<option th:each="st : ${orderStatus}" th:value="${st.id}"
											th:text="${st.statusName}"></option>
								</select></td>
							</tr>
							<tr>
								<td>
									<label for="paymentMethodSearch">Hình thức thanh toán</label>
									<select name="paymentMethod" id="paymentMethodSearch" class="form-control">
										<option value="">-- Chọn hình thức thanh toán --</option>
										<option value="0">Trả trước</option>
										<option value="1">Trả sau</option>
										<option value="2">Tài khoản</option>
									</select>
								</td>
								<td></td>
							</tr>
							<tr class='control'>
								<td colspan='4' align='center'>
									<button type="button" class="btn btn-primary button-control"
										name="doSearch" id="doSearch">
										<i class="fa fa-search"></i> Tìm kiếm
									</button>&nbsp;
									<button type="button" id="doNewSearch" class="btn btn-primary button-control"
											data-target="#modal-command-type-create"> <i
										class="fa fa-plus-square"></i> Thêm mới
								</button>&nbsp;
								</td>
							</tr>
						</table>
					</form>
				</div>
				<div class="list-service box box-primary">
					<table class="table table-bordered">
						<thead>
							<tr align="center">
								<th>Mã đơn hàng</th>
								<th>CTKV</th>
								<th>Đại lý</th>
								<th>Giá trị đơn hàng (VNĐ)</th>
								<th>Số tiền sau khi chiết khấu (VNĐ)</th>
								<th>Số tiền tiêu dùng (VNĐ)</th>
								<th>Ngày bắt đầu</th>
								<th>Ngày kết thúc</th>
								<th>Ngày tạo</th>
								<th>Ngày cập nhập</th>
								<th>Hình thức thanh toán</th>
								<th>Trạng thái</th>
								<th>Hành động</th>
							</tr>
						</thead>
						<tbody id="tableBody"></tbody>
					</table>
					<nav aria-label="Page navigation">
						<ul class="pagination">
							<li class="page-item"><span id="totalPage"></span></li>
							<li class="page-item"><span id="pageSize"></span></li>
							<li class="page-item">
								<div class="form-group">
									<select class="form-control" name="selector"
										onChange="resetPage()">
										<option>10</option>
										<option>20</option>
										<option>50</option>
										<option>100</option>
										<option>200</option>
									</select>
								</div>
							</li>
							<li class="page-item"><span>&nbsp;</span></li>
							<li class="page-item"><a class="page-link"
								onClick="firstPage()"><i class="fa fa-angle-double-left"></i></a></li>
							<li class="page-item"><a class="page-link"
								onClick="prevPage()"><i class="fa fa-angle-left"></i></a></li>
							<li class="page-item"><a id="prePage"></a></li>
							<li class="page-item"><a class="page-link" id="currentPage">1</a></li>
							<li class="page-item"><a id="nexPage"></a></li>
							<li class="page-item"><a class="page-link"
								onClick="nextPage()"><i class="fa fa-angle-right"></i></a></li>
							<li class="page-item"><a class="page-link"
								onClick="lastPage()"><i class="fa fa-angle-double-right"></i></a></li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</div>
	<!--modal form create-->
	<div class="modal fade in" id="modal-command-type-create" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title">
						<h4 class="modal-title">THÊM MỚI ĐƠN HÀNG ĐẠI LÝ</h4>
					</div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="create_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>

		</div>
	</div>

	<!--modal form edit-->
	<div class="modal fade in" id="modal-command-type-edit" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">CHỈNH SỬA ĐƠN HÀNG ĐẠI LÝ</h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="edit_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<!--modal form detail-->
	<div class="modal fade in" id="modal-command-type-detail" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">CHI TIẾT ĐƠN HÀNG ĐẠI LÝ</h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="detail_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<!--modal form call api-->
	<div class="modal fade in" id="modal-command-type-call" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">XUẤT HOÁ ĐƠN SANG BHTT</h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="call_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<!--modal form pay confirm-->
	<div class="modal fade in" id="modal-command-type-pay-confirm" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">Xác nhận thanh toán</h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="pay_confirm_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<!--modal form pay confirm-update-->
	<div class="modal fade in" id="modal-command-type-pay-confirm-update" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" style="width: 100%; margin-top: 50px;">
			<div class="modal-content">
				<div class="modal-header bg-yellow" style="display: flex;">
					<div class="title"><h4 class="modal-title">Xác nhận thanh toán</h4></div>
					<button type="button" data-dismiss="modal" class="close" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="pay_confirm_update_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<!--modal form list activate-->
	<div class="modal fade in" id="modal-command-type-list-act" style="display: none;"  data-backdrop="static" data-keyboard="false" >
		<div class="modal-dialog modal-xl overflow-auto" >
			<div class="modal-content">
				<div class="modal-header bg-yellow">
					<h4 class="modal-title">Chi tiết kích hoạt</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body" id="list_act_table">

				</div>
				<div class="modal-footer" style="text-align: center;">
				</div>
			</div>
		</div>
	</div>

	<script src="/vasonline/js/select2.min.js"></script>
	<script src="/vasonline/js/bootstrap-datepicker.min.js"></script>
	<script src="/vasonline/js/custom_service.js"></script>
	<script src="/vasonline/js/agency-order-search.js"></script>
	<script type="text/javascript">
		$(".select").select2();

		//$(".select2").select2();
		$(document).on("click", ".delete", function(e) {
			e.preventDefault();
			var r = confirm("Bạn muốn xóa đơn hàng?");
			if (r) {
				window.location = $(this).attr('href');

			}
		})
		$(document).on("click", ".browse", function(e) {
			e.preventDefault();
			var r = confirm("Bạn muốn chuyển trạng thái đơn hàng sang chờ duyệt?");
			if (r) {
				window.location = $(this).attr('href');

			}
		});
		$(document).on("click", ".wait-pay", function(e) {
			e.preventDefault();
			var r = confirm("Bạn muốn chuyển trạng thái đơn hàng sang chờ thanh toán?");
			if (r) {
				window.location = $(this).attr('href');

			}
		});
		$(document).on("click", ".actived", function(e){
			e.preventDefault();
			var r = confirm("Bạn muốn chuyển trạng thái đơn hàng sang đã kích hoạt?");
			if (r) {
				window.location = $(this).attr('href');

			}
		});
		$(document).on("click", ".closed", function(e){
			e.preventDefault();
			var r = confirm("Bạn muốn hủy đơn hàng?");
			if (r) {
				window.location = $(this).attr('href');

			}
		});
		$(document).on("click", ".call-success", function(e){
			e.preventDefault();
			var r = confirm("Bạn muốn chuyển trạng thái đơn hàng sang đã hoàn thành?");
			if (r) {
				window.location = $(this).attr('href');

			}
		});
		function messageSuccess(){
			toastr.success('Thành công');
		}
		function messageFailed(){
			toastr.error('Thất bại');
		}
		$(document).ready(function() {
			$('#sidebarCollapse').on('click', function() {
				$('#sidebar').toggleClass('active');
			});
			$("td.price").each(function() {
				$(this).html(parseFloat($(this).text()).toLocaleString());
			});
			$("#startDateSearch").datepicker({
				format : "dd/mm/yyyy",
				todayHighlight : true
			});
			$("#endDateSearch").datepicker({
				format : "dd/mm/yyyy",
				todayHighlight : true
			});
			let messageResponse = '[[${message}]]';
			if(messageResponse == 'success'){
				messageSuccess();
			}
			if (messageResponse == 'failed'){
				messageFailed();
			}
			if (messageResponse == 'HTTP Status 400 – Bad Request'){
				toastr.error("HTTP Status 400 – Bad Request");
			}
			if (messageResponse != 'HTTP Status 400 – Bad Request' && messageResponse != 'success' && messageResponse != 'failed' && messageResponse != ''){
				toastr.error(messageResponse);
			}
		});
		if ($("#selectCTKVSearch").val() != '' && $("#agencyNameSearch").val() == ''){
			if($("#selectCTKVSearch").val() == 'all'){
				var linkPost = "/vasonline/get-all-agency";
				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function (data) {
						var str = '<option value= "" >-- Chọn đại lý - AM/KAM --</option>';
						for (let i = 0; i < data.length; i++) {
							if(data[i].status == 0){
								str += ' <option value= "' + data[i].id + '" >' + data[i].agencyCode + '-' + data[i].agencyName + '</option>'
							}
						}
						$('#agencyNameSearch').html(str);
					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
			else {
				var linkPost = "/vasonline/get-all-agency-by-area?areaId=" + $("#selectCTKVSearch").val();
				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function (data) {
						var str = '<option value= "" >-- Chọn đại lý - AM/KAM --</option>';
						for (let i = 0; i < data.length; i++) {
							if (data[i].status == 0) {
								str += ' <option value= "' + data[i].id + '" >' + data[i].agencyCode + '-' + data[i].agencyName + '</option>'
							}
						}
						$('#agencyNameSearch').html(str);
					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
		}
		$("#selectCTKVSearch").on("change", function (e) {
			let value = Array.from(e.target.selectedOptions, option => option.value);
			// $('input:hidden[name=brand]').val(value);
			if(value == 'all'){
				var linkPost = "/vasonline/get-all-agency";

				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function (data) {

						var str = '<option value= "" >-- Chọn đại lý - AM/KAM --</option>';

						for (let i = 0; i < data.length; i++) {
							if(data[i].status == 0){
								str += ' <option value= "' + data[i].id + '" >' + data[i].agencyCode + '-' + data[i].agencyName + '</option>'
							}
						}
						$('#agencyNameSearch').html(str);

					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
			else {
				var linkPost = "/vasonline/get-all-agency-by-area?areaId=" + value.toString();

				$.ajax({
					url: linkPost,
					method: 'GET',
					success: function (data) {

						var str = '<option value= "" >-- Chọn đại lý - AM/KAM --</option>';

						for (let i = 0; i < data.length; i++) {
							if (data[i].status == 0) {
								str += ' <option value= "' + data[i].id + '" >' + data[i].agencyCode + '-' + data[i].agencyName + '</option>'
							}
						}
						$('#agencyNameSearch').html(str);

					},
					error: function (request) {
						alert("The request failed: " + request.responseText);
					}
				});
			}
		});
	</script>
</body>

</html>