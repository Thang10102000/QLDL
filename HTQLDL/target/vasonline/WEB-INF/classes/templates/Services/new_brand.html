<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      lang="vi">
<head th:replace="fragments/html-head">
    <meta charset="utf-8">
    <title>Thêm mới gói cước</title>
</head>

<body>
    <form th:action="@{/new-brand}" method="post" id="form">
        <table class="table table-condensed col">
            <tr>
            <tr>
                <td><label for="serviceModal">Dịch vụ</label>
                    <select name="service" id="serviceModal" class="form-control">
                        <option value="">--Chọn dịch vụ--</option>
                        <option th:each="se : ${service}" th:value="${se.id}" th:text="${se.serviceName}"></option>
                    </select>
                </td>
                <td>
                    <label for="brandGroup">Nhóm gói cước <b class="required">(*)</b></label>
                    <select name="brandGroup" id="brandGroup" class="form-control">
                        <option value="">--Chọn dịch vụ--</option>
                    </select>
                    <span class="required" id="messageBrandGroup"></span>
                </td>
            </tr>
                <td style="width: 50%">
                    <label for="brandId">Mã gói cước<b class="required">(*)</b></label>
                    <input type="text" name="brandId" class="form-control" placeholder="Mã gói cước" id="brandId"
                     autocomplete="off">
                    <span class="required" id="messageBrandId"></span>
                </td>
                <td style="width: 50%">
                    <label for="brandName">Tên gói cước <b class="required">(*)</b></label>
                    <input type="text" name="brandName" class="form-control" placeholder="Tên gói cước" id="brandName"
                     autocomplete="off">
                    <span class="required" id="messageBrandName"></span>
                </td>
            </tr>
            <tr>
                <td style="width: 50%">
                    <label for="brandType">Loại gói cước <b class="required">(*)</b></label>
                    <select name="brandType" id="brandType" class="form-control">
                        <option value="0">Trả trước</option>
                        <option value="1">Trả sau</option>
                    </select>
                </td>
                <td style="width: 50%">
                    <label for="status">Trạng thái <b  class="required">(*)</b></label>
                    <select name="status" id="status" class="form-control">
                        <option value="0">Hiệu lực</option>
                        <option value="1">Không hiệu lực</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td style="width: 50%">
                    <label for="activeDay">Số ngày hiệu lực<b  class="required">(*)</b></label>
                    <input type="number" name="activeDay" class="form-control" placeholder="Số ngày hiệu lực" id="activeDay" autocomplete="off">
                    <span class="required" id="messageActiveDay"></span>
                </td>
                <td style="width: 50%">
                    <label for="description">Mô tả</label>
                    <textarea rows="1" name="description" class="form-control" placeholder="Mô tả" id="description" autocomplete="off"></textarea>
                </td>
            </tr>
            <tr>
                <td><label for="approvedBy">Quyền duyệt</label>
                    <select name="approvedBy" id="approvedBy" class="form-control">
                        <option value="0">MDS và Công ty khu vực</option>
                        <option th:each="lv : ${levels}" th:value="${lv.levelId}"
                                th:text="${lv.levelName}"></option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><input type="checkbox" id="brandFreeNew" name="brandFree">
                    Gói miễn phí
                </td>
                <td></td>
            </tr>
            <tr class="notFreeBrandNew" hidden>
                <td><label for="typeDiscountCommissionNew">Chọn loại tỉ lệ</label>
                    <select name="typeDiscountCommission" id="typeDiscountCommissionNew" class="form-control">
                        <option value="0">Tỉ lệ hoa hồng</option>
                        <option value="1">Tỉ lệ chiết khấu</option>
                    </select>
                </td>
                <td class="commissionRateShowNew"><input type="checkbox" id="commissionDefaultNew">
                    Tỉ lệ hoa hồng riêng
                </td>
                <td class="discountRateShowNew"><input type="checkbox" id="discountDefaultNew">
                    Tỉ lệ chiết khấu riêng
                </td>
            </tr>
            <tr class="priceBrandShowNew" hidden>
                <td>
                    <label for="priceBrand">Giá gói cước<b class="required">(*)</b></label>
                    <input type="text" name="priceBrand" class="form-control" data-type='currency' placeholder="Giá gói cước" id="priceBrand" autocomplete="off" min="1">
                    <span class="required" id="messagePriceBrand"></span>
                </td>
                <td class="commissionRateShowNew" id="commissionDataNew" hidden>
                    <label for="commissionRate">Tỉ lệ hoa hồng(%) </label>
                    <input type="number" name="commissionRate" class="form-control"
                           placeholder="Tỉ lệ hoa hồng" id="commissionRate" autocomplete="off">
                    <span class="required" id="messageCommission"></span>
                    <input type="hidden" id="tlfor" name="tlfor" value="1">
                </td>
                <td class="discountRateShowNew" hidden>
                    <label for="amountDiscount">Mức chiết khấu</label>
                    <input type="text" name="amountDiscount" class="form-control" placeholder="Mức chiết khấu"
                           id="amountDiscount" autocomplete="off" min="1">
                </td>
            </tr>
            <tr class="discountRateShowNew" hidden>
                <td id="discountData">
                    <label for="discountRate">Tỷ lệ chiết khấu(%) <b class="required">(*)</b></label>
                    <input type="number" name="discountRate" class="form-control" placeholder="Tỷ lệ chiết khấu"
                           id="discountRate" autocomplete="off" min="1">
                    <span class="required" id="messageDiscount"></span>
                </td>
                <td>
                    <label for="priceDiscount">Giá sau chiết khấu <b class="required">(*)</b></label>
                    <input type="text" name="priceDiscount" class="form-control"
                        placeholder="Giá sau chiết khấu" id="priceDiscount"
                        autocomplete="off">
                    <span class="required" id="messagePriceDiscount"></span>
                </td>
            </tr>
            <tr class='control'>
                <td colspan='4' align='center'>
                    <button type="submit" class="btn btn-primary button-control new"
                            name="doNew" id="doNew">
                        <i class="fa fa-plus-square"></i> Thêm mới
                    </button>
                    <a type="button" id="doBack"
                       class="btn btn-primary button-control" data-dismiss="modal"><i
                            class="fa fa-undo" aria-hidden="true"></i> Quay lại</a>
                </td>
            </tr>
        </table>
    </form>

<script src="/vasonline/js/custom_service.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $("#brandFreeNew").prop("checked", true);
        $("#commissionDefaultNew").prop("checked", true);
        $("#discountDefaultNew").prop("checked", true);
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
        });

    });
    $(':checkbox').change(function () {
        //check brand not free
        if (!$("#brandFreeNew").is(":checked")){
            if ($("#typeDiscountCommissionNew").val() == "0"){
                $(".commissionRateShowNew").removeAttr("hidden");
                $(".priceBrandShowNew").removeAttr("hidden");
                $(".notFreeBrandNew").removeAttr("hidden");
                $(".discountRateShowNew").attr("hidden",true);
            }else {
                $(".discountRateShowNew").removeAttr("hidden");
                $(".notFreeBrandNew").removeAttr("hidden");
                $(".priceBrandShowNew").removeAttr("hidden");
                $(".commissionRateShowNew").attr("hidden",true);
            }
        }else {
            $(".notFreeBrandNew").attr("hidden",true);
            $(".commissionRateShowNew").attr("hidden",true);
            $(".priceBrandShowNew").attr("hidden",true);
            $(".discountRateShowNew").attr("hidden",true);
            $("#priceBrand").val(0);
            $("#commissionRate").val(0);
            $("#dcPolicyId").val("");
            $("#discountRate").val(0);
            $("#priceDiscount").val(0);
        }
    });

    //tính giá sau chiết khấu
    $("#priceBrand").on("keyup",function () {
        if ($("#discountRate").val() != "" && $("#priceBrand").val() != ""){
            let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
            document.getElementById("priceDiscount").value = priceBrand - (document.getElementById("discountRate").value * priceBrand / 100);
            document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
        }
        if($("#discountRate").val() == ""){
            let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
            // var priceDiscount = $("#priceBrand").val();
            $("#priceDiscount").val(priceBrand);
            document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
        }
        if($("#priceBrand").val() == ""){
            $("#priceDiscount").val(0);
            $("#amountDiscount").val(0);
        }
    });
    $("#discountRate").on("keyup",function () {
        if ($("#discountRate").val() != "" && $("#priceBrand").val() != ""){
            let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
            document.getElementById("priceDiscount").value = priceBrand - (document.getElementById("discountRate").value * priceBrand / 100);
            document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
        }
        if($("#discountRate").val() == ""){
            let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
            // var priceDiscount = $("#priceBrand").val();
            $("#priceDiscount").val(priceBrand);
            document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;

        }
        if($("#priceBrand").val() == ""){
            $("#priceDiscount").val(0);
            $("#amountDiscount").val(0);
        }
    });
    $("#priceDiscount").on("keyup",function () {
        if ($("#priceBrand").val() != "" ){
            let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
            document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
        }
        // if($("#discountRate").val() == ""){
        //     let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
        //     // var priceDiscount = $("#priceBrand").val();
        //     $("#priceDiscount").val(priceBrand);
        //     document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
        // }
        // if($("#priceBrand").val() == ""){
        //     $("#priceDiscount").val(0);
        //     $("#amountDiscount").val(0);
        // }
    });

    // change from commission to discount
    $("#typeDiscountCommissionNew").on("change", function () {
        if ($("#typeDiscountCommissionNew").val() == "0"){
            $(".commissionRateShowNew").removeAttr("hidden");
            $(".priceBrandShowNew").removeAttr("hidden");
            $(".notFreeBrandNew").removeAttr("hidden");
            $(".discountRateShowNew").attr("hidden",true);
        }else {
            $(".discountRateShowNew").removeAttr("hidden");
            $(".notFreeBrandNew").removeAttr("hidden");
            $(".priceBrandShowNew").removeAttr("hidden");
            $(".commissionRateShowNew").attr("hidden",true);
        }
    })



    $("#brandId , #brandName, #activeDay, #priceBrand, #discountRate").keydown(function () {
        $("#messageBrandId").text("");
        $("#messageBrandName").text("");
        $("#messageActiveDay").text("");
        $("#messagePriceBrand").text("");
        $("#messageDiscount").text("");
    });

    //chính sách hoa hồng
    $("#commissionDefaultNew:checkbox").on('change',function(){
        if(!$(this).is(':checked')) {
            let link = "/vasonline/default-commissionRate";
            $.ajax({
                url: link,
                method: 'GET',
                success: function (data) {
                    var str =  '<label for="dcPolicyId">Chính sách hoa hồng</label>' +
                        '<select name="dcPolicyId" id="dcPolicyId" class="form-control">';
                    for (let i = 0; i < data.length; i++) {
                        str += ' <option value= "' + data[i].id + '" >' + data[i].policyName + '</option>';
                    }
                    str +='  </select>'
                    $("#commissionDataNew").html(str);

                },
                error: function (request) {
                    alert("The request failed: " + request.responseText);
                }
            })
        }else {
            var str = '<label for="commissionRate">Tỉ lệ hoa hồng(%) </label>\n' +
                '<input type="number" name="commissionRate" class="form-control"\n' +
                '       placeholder="Tỉ lệ hoa hồng" id="commissionRate" autocomplete="off">\n' +
                '<span class="required" id="messageCommission"></span>\n' +
                '<input type="hidden" id="tlfor" name="tlfor" value="1">';
            $("#commissionDataNew").html(str);
        }
    });

    //chính sách chiết khấu
    $("#discountDefaultNew:checkbox").on('change',function(){
        if(!$(this).is(':checked')) {
            let link = "/vasonline/default-discountRate";
            $.ajax({
                url: link,
                method: 'GET',
                success: function (data) {
                    $("#discountRate").val(data.discountRate);
                    $('#discountRate').attr('readonly', true);
                    let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
                    document.getElementById("priceDiscount").value = priceBrand - (document.getElementById("discountRate").value * priceBrand / 100);
                    document.getElementById("amountDiscount").value = priceBrand - document.getElementById("priceDiscount").value;
                },
                error: function (request) {
                    alert("The request failed: " + request.responseText);
                }
            })
        }else {
            $("#discountRate").val("");
            $('#discountRate').removeAttr('readonly');
            if($("#priceBrand").val() != ""){
                let priceBrand = parseInt(document.getElementById("priceBrand").value.replace(/,/g, ''));
                $("#priceDiscount").val(priceBrand);
            }
            if($("#priceBrand").val() == ""){
                $("#priceDiscount").val(0);
                $("#amountDiscount").val(0);
            }
        }
    });

    $(document).on("change","#serviceModal",function(){
        let link = "/vasonline/brand-group-list?idService="+ $("#serviceModal").val();
        $.ajax({
            url: link,
            method: 'GET',
            success: function(data) {

                var str ='';

                for (let i = 0; i < data.length ; i++) {
                    str += ' <option value= "' + data[i].id + '" >' + data[i].groupName + '</option>';
                }
                $("#brandGroup").html(str);

            },
            error: function(request) {
                alert("The request failed: " + request.responseText);
            }
        })
    })
    $(".new").on('click', function () {
        var format = /[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
        if (format.test($("#brandId").val())) {
            $("#messageBrandId").text("Mã gói cước chứa ký tự đặc biệt");
            $("#brandId").focus();
            return false;
        }
        if ($("#brandId").val().trim() === '') {
            $("#messageBrandId").text("Bạn chưa nhập mã gói cước");
            $("#brandId").focus();
            return false;
        }
        if ($("#brandName").val().trim() === '') {
            $("#messageBrandName").text(
                "Bạn chưa nhập tên gói cước");
            $("#brandName").focus();
            return false;
        }
        if ($("#activeDay").val().trim() === '') {
            $("#messageActiveDay").text(
                "Bạn chưa nhập số ngày hiệu lực");
            $("#activeDay").focus();
            return false;
        }
        if ($("#brandGroup").val().trim() === '') {
            $("#messageBrandGroup").text(
                "Bạn chưa nhập số ngày hiệu lực");
            $("#brandGroup").focus();
            return false;
        }
        if ($("#activeDay").val() * 1 < 0) {
            $("#messageActiveDay").text("Số ngày hiệu lực không hợp lệ");
            $("#activeDay").focus();
            return false;
        }
        if ($("#brandFreeNew").prop("checked") == false) {
            if ($("#priceBrand").val() === '') {
                console.log("1");
                $("#messagePriceBrand").text("Bạn chưa nhập giá gói cước");
                $("#priceBrand").focus();
                return false;
            }
            if ($("#priceBrand").val() * 1 < 0) {
                console.log("2");
                $("#messagePriceBrand").text("Giá gói cước không hợp lệ");
                $("#priceBrand").focus();
                return false;
            }
            if ($("#discountRate").val().trim() === '' && $("#typeDiscountCommissionNew").val() == "1") {
                console.log("3");
                $("#messageDiscount").text("Bạn chưa nhập tỉ lệ chiết khấu");
                $("#discountRate").focus();
                return false;
            }
            if ($("#priceDiscount").val() === '') {
                $("#messagePriceDiscount").text("Bạn chưa tính giá sau chiết khấu");
                $("#priceDiscount").focus();
                return false;
            }
            if ($("#commissionRate").val() === '' && $("#typeDiscountCommissionNew").val() == "0") {
                console.log("4");
                $("#messageCommission").text("Bạn chưa nhập tỉ lệ hoa hông");
                $("#commissionRate").focus();
                return false;
            }
            if ($("#commissionRate").val() * 1 < 0 || $("#commissionRate").val() * 1 > 100) {
                console.log("5");
                $("#messageCommission").text("Tỉ lệ hoa hồng không hợp lệ");
                $("#commissionRate").focus();
                return false;
            }
            if ($("#discountRate").val() * 1 < 0 || $("#discountRate").val() * 1 > 100) {
                console.log("6");
                $("#messageDiscount").text("Tỉ lệ chiết khấu không hợp lệ");
                $("#discountRate").focus();
                return false;
            }
        }
    })
    var invalidChars = ["-", "+", "e", ",", "."];
    $("#activeDay").on("keydown", function (e) {
        if (invalidChars.includes(e.key)) {
            e.preventDefault();
        }
    });
</script>
</body>

</html>