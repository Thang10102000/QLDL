<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/html-head">
    <meta charset="UTF-8">
    <title>Thêm mới</title>
</head>
<body>
    <form th:action="@{/deposite/add}"
          method="post" enctype="multipart/form-data" id="fileUploadForm">
        <table class="table table-condensed col">
            <tr>
                <td width="50%">
                <label for="areaId">Công ty khu vực<b class="required"> (*)</b></label>
                        <select name="areaId" id="areaId" class="form-control"  th:if="${#lists.size(listArea) >= 2}">
                            <option value="">--Chọn công ty khu vực--</option>
                            <option th:each="j : ${listArea}" th:value="${j.areaId}" th:text="${j.areaName}" ></option>
                        </select>
                    <select name="areaId" id="areaId" class="form-control"  th:if="${#lists.size(listArea) < 2}">
                        <option th:each="j : ${listArea}" th:value="${j.areaId}" th:text="${j.areaName}" ></option>
                    </select>
                        <span id="areaId_msg"></span>
                </td>
                <td>
                    <label for="agencyId">Đại lý bảo lãnh thanh toán<b class="required"> (*)</b></label>
                    <select name="agencyId" id="agencyId" class="form-control" th:if="${agency != null}">
                        <option th:each="ag : ${agency}" th:value="${ag.id}" th:text="${ag.agencyName}" ></option>
                    </select>
                    <select name="agencyId" id="agencyId" class="form-control" th:if="${agency == null}">
                        <option value="">--Chọn đại lý--</option>
                    </select>
                    <span id="agencyId_msg"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="startDate">Ngày bắt đầu<b class="required"> (*)</b></label>
                    <input type="text" name="startDate" class="form-control" id="startDate" autocomplete="off"/>
                    <span id="startDate_msg"></span>
                </td>
                <td>
                    <label for="endDate">Ngày kết thúc<b class="required"> (*)</b></label>
                    <input type="text" name="endDate" class="form-control" id="endDate" autocomplete="off"/>
                    <span id="endDate_msg"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="contractId">Hợp đồng đại lý<b class="required"> (*)</b></label>
                    <select name="contractId" id="contractId" class="form-control">
                        <option value="">-- Chọn hợp đồng --</option>
                    </select>
                    <span id="agencyContractId_msg"></span>
                </td>
                <td>
                    <label for="depositNo">Số chứng thư<b class="required"> (*)</b></label>
                    <input type="text" name="depositNo" class="form-control"  id="depositNo" autocomplete="off" />
                    <span id="depositNo_msg"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="depositsAmount">Số tiền bảo lãnh (VNĐ)<b class="required"> (*)</b></label>
                    <input type="text" name="depositsAmount" class="form-control"  id="depositsAmount" autocomplete="off"
                           data-type='currency' maxlength="14"/>
                    <span id="depositsAmount_msg"></span>
                </td>
                <td>
                    <label for="receivedDate">Ngày ký <b class="required"> (*)</b></label>
                    <input type="text" name="receivedDate" class="form-control"  id="receivedDate" autocomplete="off"/>
                    <span id="receivedDate_msg"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="customerName">Người đại diện </label>
                    <input type="text" name="customerName" class="form-control"  id="customerName" autocomplete="off" />
                    <span id="customerName_msg"></span>
                </td>
                <td>
                    <label for="contractAddendum">Upload chứng thư</label>
                    <input type="file" name="files[]" multiple id="contractAddendum" accept="image/*"/>
                    <span id="file_msg"></span>
                </td>
            </tr>

            <tr class='control'>
                <td colspan='4' align='center'>
                    <button type="submit" class="btn btn-primary button-control"
                            name="doNew" id="doNew"><i class="fa fa-plus-square"></i>
                        Thêm mới
                    </button>
                    <button type="button" id="doBack" class="btn btn-primary button-control" data-dismiss="modal" ><i class="fa fa-undo" aria-hidden="true"></i> Quay
                        lại</button>
                </td>
            </tr>
        </table>
    </form>
<script src="/vasonline/js/custom_service.js"></script>
<script src="/vasonline/js/bootstrap-datepicker.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script type="text/javascript">
    $(document).on("click","#doNew",function (event) {
    	if ($("#agencyId").val() === "") {
            $("#agencyId_msg").text("Bạn chưa chọn đại lý");
            $('#agencyId_msg').attr('style', 'display:block;color: red');
            return false;
        }
    	if ($('#depositsAmount').val() == '') {
            $('#depositsAmount_msg').html('Vui lòng nhập số tiền bảo lãnh');
            $('#depositsAmount_msg').attr('style', 'display:block;color: red');
            return false;
        }
    	if ($('#startDate').val() == '') {
            $('#startDate_msg').html('Vui lòng nhập ngày hết hiệu lực');
            $('#startDate_msg').attr('style', 'display:block;color: red');
            return false;
        }
    	if ($('#endDate').val() == '') {
            $('#endDate_msg').html('Vui lòng nhập ngày kết thúc hiệu lực');
            $('#endDate_msg').attr('style', 'display:block;color: red');
            return false;
        }
    	if ($('#status').val() == '') {
            $('#status_msg').html('Vui lòng nhập trạng thái');
            $('#status_msg').attr('style', 'display:block;color: red');
            return false;
        }

    //	check end date > start date
        var ngaybatdau = $('#startDate').val();
        var ngayketthuc = $('#endDate').val();
        ngaybatdau = parseDate(ngaybatdau).getTime();
        ngayketthuc = parseDate(ngayketthuc).getTime();

        if (ngaybatdau > ngayketthuc) {
            $('#endDate_msg').html('Vui lòng nhập ngày kết thúc lớn hơn ngày bắt đầu!');
            $('#endDate_msg').attr('style', 'display:block;color: red');
            return false;
        }
    });

    $("#depositsAmount").on("keyup", function () {
        $('#depositsAmount_msg').html('');
    });
    $("#agencyId, #status, #startDate, #endDate").on('change',function () {
        $('#agencyId_msg').html('');
        $('#status_msg').html('');
        $('#startDate_msg').html('');
        $('#endDate_msg').html('')
    })
</script>
<script>
    $(document).ready(function () {
        if ($("#areaId").val() != '' && $("#agencyId").val() == ""){
            var linkPost = "/vasonline/agency-list?idAgencyArea="+ $("#areaId").val();
            $.ajax({
                url: linkPost,
                method: 'GET',
                success: function(data) {
                    var str ='<option value="">--Chọn đại lý--</option>';
                    for (let i = 0; i < data.length ; i++) {
                        str +='<option value= "'+data[i].id+'" >'+data[i].agencyName+'</option>'
                    }
                    $('#agencyId').html(str);
                },
                error: function(request) {
                    alert("The request failed: " + request.responseText);
                }
            });
        }
        $("#areaId").on("change", function (e) {
	            let value = Array.from(e.target.selectedOptions, option => option.value);
	            // $('input:hidden[name=brand]').val(value);
	            var linkPost = "/vasonline/agency-list?idAgencyArea="+ value;

	            $.ajax({
	                url: linkPost,
	                method: 'GET',
	                success: function(data) {

	                    var str ='<option value="">--Chọn đại lý--</option>';

	                    for (let i = 0; i < data.length ; i++) {
	                        if (data[i].status == 0){
                                str +='<option value= "'+data[i].id+'" >'+data[i].agencyName+'</option>'
                            }
	                    }
	                    $('#agencyId').html(str);

	                },
	                error: function(request) {
	                    alert("The request failed: " + request.responseText);
	                }
	            });
	        });

        // Date picker
        $("#startDate").datepicker({
            format: "dd/mm/yyyy", todayHighlight: true,
            onSelect: function(dateText, inst){
                $('#endDate').datepicker('option', 'minDate', new Date(dateText));
            }
        }).datepicker("setDate", new Date());
        $("#endDate").datepicker({
            format: "dd/mm/yyyy", todayHighlight: true,
            onSelect: function(dateText, inst){
                $('#startDate').datepicker('option', 'maxDate', new Date(dateText));
            }
        });
        $("#receivedDate").datepicker({
            format: "dd/mm/yyyy", todayHighlight: true,
            onSelect: function(dateText, inst){
                $('#startDate').datepicker('option', 'maxDate', new Date(dateText));
            }
        })
        // CreateDate is hidden
        //$("#createDate").datepicker({format: "yyyy/mm/dd"}).datepicker("setDate", new Date());
    });

    $("#agencyId").on("change", function (e) {
        let value = Array.from(e.target.selectedOptions, option => option.value);
        // $('input:hidden[name=brand]').val(value);
        var linkPost = "/vasonline/deposite/agency-contract-by-agency-id?agencyId="+ value;

        $.ajax({
            url: linkPost,
            method: 'GET',
            success: function(data) {

                var str ='<option value="">-- Chọn hợp đồng --</option>';

                for (let i = 0; i < data.length ; i++) {
                    // if (data[i].status == 0){
                        str +='<option value= "'+data[i].id+'" >'+ data[i].contractNo +' - ' +data[i].agencyAC.agencyName + '</option>'
                    // }
                }
                $('#contractId').html(str);

            },
            error: function(request) {
                alert("The request failed: " + request.responseText);
            }
        });
    });

</script>
</body>
</html>
